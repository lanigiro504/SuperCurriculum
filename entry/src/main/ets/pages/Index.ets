import { CourseItem, TimeSlot, WeekDay } from '../models/CourseModel';
import { CourseService } from '../services/CourseService';
import router from '@ohos.router';

@Entry
@Component
struct Index {
  @State currentWeek: number = 15;
  @State courses: CourseItem[] = [];
  @State currentTabIndex: number = 1; // é»˜è®¤é€‰ä¸­è¯¾ç¨‹è¡¨
  private courseService: CourseService = new CourseService();
  private swiperController: SwiperController = new SwiperController();

  // å‘¨æ•°èŒƒå›´
  private readonly totalWeeks: number = 20;
  private readonly startWeek: number = 1;
  
  // ç”Ÿæˆå‘¨æ•°æ•°ç»„
  private weekNumbers: number[] = Array.from<number, number>({ length: this.totalWeeks }, (_, i: number) => i + this.startWeek);

  // æ—¶é—´æ®µé…ç½®
  private timeSlots: TimeSlot[] = [
    { label: '1', startTime: '08:30', endTime: '09:15' },
    { label: '2', startTime: '09:20', endTime: '10:05' },
    { label: '3', startTime: '10:25', endTime: '11:10' },
    { label: '4', startTime: '11:15', endTime: '12:00' },
    { label: '5', startTime: '13:00', endTime: '14:45' },
    { label: '6', startTime: '14:50', endTime: '15:35' },
    { label: '7', startTime: '15:55', endTime: '16:40' },
    { label: '8', startTime: '16:45', endTime: '17:30' },
    { label: '9', startTime: '19:00', endTime: '19:45' },
    { label: '10', startTime: '19:50', endTime: '20:35' }
  ];

  // æ˜ŸæœŸå’Œæ—¥æœŸ
  private weekDays: WeekDay[] = [
    { day: 'å‘¨ä¸€', date: '5/26' },
    { day: 'å‘¨äºŒ', date: '5/27' },
    { day: 'å‘¨ä¸‰', date: '5/28' },
    { day: 'å‘¨å››', date: '5/29' },
    { day: 'å‘¨äº”', date: '5/30' },
    { day: 'å‘¨å…­', date: '5/31' },
    { day: 'å‘¨æ—¥', date: '6/01' }
  ];

  aboutToAppear() {
    this.loadTestCourses();
  }

  loadTestCourses() {
    // æ·»åŠ ä¸€äº›æµ‹è¯•è¯¾ç¨‹æ•°æ®
    this.courses = [
      new CourseItem({ id: '1', name: 'å¤§æ•°æ®æŠ€æœ¯', teacher: 'é™ˆç›Šæ‰', classroom: 'é—»é“109', weekDay: 4, timeSlot: 1, duration: 2, weekStart: 1, weekEnd: 18, color: '#FFB74D' }),
      new CourseItem({ id: '2', name: 'æœºå™¨å­¦ä¹ ', teacher: 'è°¢æ¶¦å±±', classroom: 'é—»é“316', weekDay: 2, timeSlot: 3, duration: 2, weekStart: 1, weekEnd: 18, color: '#F48FB1' }),
      new CourseItem({ id: '3', name: 'å¤§æ•°æ®æŠ€æœ¯', teacher: 'é™ˆç›Šæ‰', classroom: 'é—»é“109', weekDay: 1, timeSlot: 5, duration: 2, weekStart: 1, weekEnd: 18, color: '#FFB74D' }),
      new CourseItem({ id: '4', name: 'é¸¿è’™åº”ç”¨å¼€å‘', teacher: 'æ›¾é¹ç¨‹', classroom: 'ä¹ç« 209', weekDay: 2, timeSlot: 5, duration: 2, weekStart: 1, weekEnd: 18, color: '#81C784' }),
      new CourseItem({ id: '5', name: 'é¸¿è’™å®éªŒè¯¾', teacher: 'æ›¾é¹ç¨‹', classroom: 'ä¹ç« 209', weekDay: 1, timeSlot: 7, duration: 2, weekStart: 1, weekEnd: 18, color: '#F8BBD9' }),
      new CourseItem({ id: '6', name: 'é¸¿è’™åº”ç”¨å¼€å‘', teacher: 'æ›¾é¹ç¨‹', classroom: 'ä¹ç« 209', weekDay: 2, timeSlot: 7, duration: 2, weekStart: 1, weekEnd: 18, color: '#81C784' }),
      new CourseItem({ id: '7', name: 'æœºå™¨å­¦ä¹ ', teacher: 'è°¢æ¶¦å±±', classroom: 'é—»é“316', weekDay: 3, timeSlot: 7, duration: 2, weekStart: 1, weekEnd: 18, color: '#F48FB1' }),
      new CourseItem({ id: '8', name: 'å¤§æ•°æ®å®éªŒè¯¾', teacher: 'é™ˆç›Šæ‰', classroom: 'ä¹ç« 402', weekDay: 1, timeSlot: 9, duration: 2, weekStart: 1, weekEnd: 18, color: '#FFB74D' }),
      new CourseItem({ id: '9', name: 'æœºå™¨å­¦ä¹ å®éªŒ', teacher: 'è°¢æ¶¦å±±', classroom: 'ä¹ç« 403', weekDay: 4, timeSlot: 9, duration: 2, weekStart: 1, weekEnd: 18, color: '#F48FB1' })
    ];
  }

  // è·å–æŒ‡å®šä½ç½®çš„è¯¾ç¨‹
  getCourseAtPosition(dayIndex: number, timeSlot: number, week: number): CourseItem | null {
    return this.courses.find((course: CourseItem) => 
      course.weekDay === dayIndex + 1 && 
      course.timeSlot === timeSlot && 
      course.isInWeek(week)
    ) || null;
  }

  // ä¸Šä¸€å‘¨
  goToPreviousWeek(): void {
    if (this.currentWeek > this.startWeek) {
      this.swiperController.showPrevious();
    }
  }

  // ä¸‹ä¸€å‘¨
  goToNextWeek(): void {
    if (this.currentWeek < this.totalWeeks) {
      this.swiperController.showNext();
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('<')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .width(24)
          .height(24)
          .textAlign(TextAlign.Center)
          .opacity(this.currentWeek > this.startWeek ? 1 : 0.3)
          .onClick(() => {
            this.goToPreviousWeek();
          })
        
        Text(`ç¬¬${this.currentWeek}å‘¨`)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Text('>')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .width(24)
          .height(24)
          .textAlign(TextAlign.Center)
          .opacity(this.currentWeek < this.totalWeeks ? 1 : 0.3)
          .onClick(() => {
            this.goToNextWeek();
          })
      }
      .width('100%')
      .height(50)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      // ä½¿ç”¨Swiperå®ç°æ»‘åŠ¨åˆ‡æ¢
      Swiper(this.swiperController) {
        ForEach(this.weekNumbers, (week: number) => {
          this.WeekView(week)
        }, (week: number) => week.toString())
      }
      .index(this.currentWeek - this.startWeek)
      .indicator(false)
      .loop(false)
      .duration(300)
      .onChange((index: number) => {
        this.currentWeek = index + this.startWeek;
      })
      .layoutWeight(1)

      // åº•éƒ¨å¯¼èˆªæ 
      Row() {
        // ä»Šæ—¥è¯¾ç¨‹Tab
        Column() {
          Text('ğŸ“š')
            .fontSize(20)
            .fontColor(this.currentTabIndex === 0 ? '#007AFF' : '#999999')
          Text('ä»Šæ—¥è¯¾ç¨‹')
            .fontSize(12)
            .fontColor(this.currentTabIndex === 0 ? '#007AFF' : '#999999')
            .margin({ top: 2 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentTabIndex = 0;
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è·³è½¬åˆ°ä»Šæ—¥è¯¾ç¨‹é¡µé¢çš„é€»è¾‘
        })

        // è¯¾ç¨‹è¡¨Tab
        Column() {
          Text('ğŸ“…')
            .fontSize(20)
            .fontColor(this.currentTabIndex === 1 ? '#007AFF' : '#999999')
          Text('è¯¾ç¨‹è¡¨')
            .fontSize(12)
            .fontColor(this.currentTabIndex === 1 ? '#007AFF' : '#999999')
            .margin({ top: 2 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentTabIndex = 1;
        })

        // è®¾ç½®Tab
        Column() {
          Text('âš™ï¸')
            .fontSize(20)
            .fontColor(this.currentTabIndex === 2 ? '#007AFF' : '#999999')
          Text('è®¾ç½®')
            .fontSize(12)
            .fontColor(this.currentTabIndex === 2 ? '#007AFF' : '#999999')
            .margin({ top: 2 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.currentTabIndex = 2;
          router.pushUrl({ url: 'pages/Settings' });
        })
      }
      .width('100%')
      .height(60)
      .backgroundColor('#FFFFFF')
      .border({ width: { top: 0.5 }, color: '#E5E5E5' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  WeekView(week: number) {
    Column() {
      // æ˜ŸæœŸå’Œæ—¥æœŸè¡¨å¤´
      Row() {
        // ç©ºç™½åŒºåŸŸå¯¹åº”æ—¶é—´åˆ—
        Column()
          .width(50)
        
        // æ˜ŸæœŸè¡¨å¤´
        ForEach(this.weekDays, (weekDay: WeekDay) => {
          Column() {
            Text(weekDay.day)
              .fontSize(14)
              .fontColor('#333333')
            Text(weekDay.date)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 2 })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)
        }, (weekDay: WeekDay) => weekDay.day)
      }
      .width('100%')
      .height(50)
      .backgroundColor('#F8F8F8')

      // è¯¾ç¨‹è¡¨ä¸»ä½“ - ä½¿ç”¨Stackæ¥æ”¾ç½®æ‚¬æµ®æŒ‰é’®
      Stack({ alignContent: Alignment.BottomEnd }) {
        // è¯¾ç¨‹è¡¨å†…å®¹
        Scroll() {
          Row() {
            // å·¦ä¾§æ—¶é—´åˆ—
            Column() {
              ForEach(this.timeSlots, (timeSlot: TimeSlot) => {
                Column() {
                  Text(timeSlot.label)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                  Text(timeSlot.startTime)
                    .fontSize(10)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                  Text(timeSlot.endTime)
                    .fontSize(10)
                    .fontColor('#666666')
                }
                .width(50)
                .height(80)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
              }, (timeSlot: TimeSlot) => timeSlot.label)
            }
            .alignItems(HorizontalAlign.Center)

            // è¯¾ç¨‹ç½‘æ ¼
            Column() {
              ForEach(this.timeSlots, (timeSlot: TimeSlot, timeIndex: number) => {
                Row() {
                  ForEach(this.weekDays, (weekDay: WeekDay, dayIndex: number) => {
                    this.CourseCell(dayIndex, parseInt(timeSlot.label), this.getCourseAtPosition(dayIndex, parseInt(timeSlot.label), week), week)
                  }, (weekDay: WeekDay) => `${weekDay.day}_${timeSlot.label}`)
                }
                .width('100%')
                .height(80)
              }, (timeSlot: TimeSlot) => `${timeSlot.label}_week${week}`)
            }
            .layoutWeight(1)
          }
        }
        .width('100%')
        .layoutWeight(1)

        // æ‚¬æµ®æ·»åŠ æŒ‰é’®
        Button({ type: ButtonType.Circle }) {
          Text('+')
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
        .width(56)
        .height(56)
        .backgroundColor('#007AFF')
        .margin({ right: 20, bottom: 80 }) // é¿å…ä¸åº•éƒ¨å¯¼èˆªæ é‡å 
        .onClick(() => {
          router.pushUrl({ url: 'pages/CourseEdit' });
        })
      }
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  CourseCell(dayIndex: number, timeSlot: number, course: CourseItem | null, week: number) {
    Column() {
      if (course !== null) {
        Column() {
          Text(course.name)
            .fontSize(13)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .textAlign(TextAlign.Center)
            .width('100%')
            .lineHeight(16)
          
          Text(`@${course.classroom}`)
            .fontSize(10)
            .fontColor('#FFFFFF')
            .opacity(0.9)
            .margin({ top: 2 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .textAlign(TextAlign.Center)
            .width('100%')
          
          Blank() // æ·»åŠ å¼¹æ€§ç©ºé—´ï¼Œå°†å†…å®¹æ¨å‘é¡¶éƒ¨
        }
        .width('100%')
        .height(course.duration * 80 - 4)
        .backgroundColor(course.color)
        .borderRadius(6)
        .padding({ top: 6, bottom: 6, left: 3, right: 3 })
        .justifyContent(FlexAlign.Start) // æ”¹ä¸ºä»é¡¶éƒ¨å¼€å§‹å¸ƒå±€
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          router.pushUrl({
            url: 'pages/CourseDetail',
            params: { courseId: course.id }
          });
        })
      } else {
        Column()
          .width('100%')
          .height(78)
          .backgroundColor('#FFFFFF')
          .border({ width: 0.5, color: '#E5E5E5' })
          .onClick(() => {
            router.pushUrl({
              url: 'pages/CourseEdit',
              params: { 
                dayOfWeek: dayIndex + 1,
                timeSlot: timeSlot,
                week: week
              }
            });
          })
      }
    }
    .layoutWeight(1)
    .padding({ left: 1, right: 1, top: 1, bottom: 1 })
  }
}